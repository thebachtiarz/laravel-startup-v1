const checkAuth = () => {
    let token = localStorage.getItem('_jwtApiToken');
    if (token) {
        let user = getUserCredentials();
        if (user) {
            $('#login-head-message').html(`<label class="text-success">Welcome Back ${user.name}</label>`), redirectTo('/home')
        } else {
            $('#login-head-message').html('<label class="text-info">Credentials has expired, please login again</label>')
        }
    }
}

$(document).on('keyup', '#email', function (e) {
    if (event.keyCode === 13) {
        e.preventDefault();
        $('#password').focus()
    }
});

$(document).on('keyup', '#password', function (e) {
    if (event.keyCode === 13) {
        e.preventDefault();
        $('#submitLogin').click()
    }
});

$(document).on('click', '#submitLogin', function () {
    let email = $('#email').val();
    let password = $('#password').val();
    var md = forge.md.sha512.sha384.create();
    md.update(password);
    let encpass = md.digest().toHex();
    if (email && encpass) { submitLogin(email, encpass), $('#email-form').removeClass('mb-1'), $('#email-form').addClass('mb-3'), $('#email-warn').hide(), $('#password-form').removeClass('mb-1'), $('#password-form').addClass('mb-3'), $('#password-warn').hide() }
    if (!email) { $('#email-form').removeClass('mb-3'), $('#email-form').addClass('mb-1'), $('#email-warn').show() }
    if (!password) { $('#password-form').removeClass('mb-3'), $('#password-form').addClass('mb-1'), $('#password-warn').show() }
});

const createLoginForm = () => {
    let loginForm = `<div class="login-box"><div class="login-logo"><a href="/" class="text-white" style="font-size: 40px; opacity: .8;"><b>Laravel</b> Startup</a></div><div class="card shadow-lg p-3 mb-5 bg-white rounded"><div class="card-body login-card-body"><p class="login-box-msg" id="login-head-message">Sign in to start your session</p><div class="form-group"><div class="input-group mb-3" id="email-form"><input type="email" id="email" class="form-control" placeholder="Email@mail.com"><div class="input-group-append"><div class="input-group-text"><span class="fas fa-envelope"></span></div></div></div><label class="text-info" id="email-warn" style="display: none;">Email incorrect</label></div><div class="form-group"><div class="input-group mb-3" id="password-form"><input type="password" class="form-control" id="password" placeholder="Password"><div class="input-group-append"><div class="input-group-text"><span class="fas fa-lock"></span></div></div></div><label class="text-info" id="password-warn" style="display: none;">Password incorrect</label></div><div class="row"><div class="col-7"><div class="icheck-primary"><input type="checkbox" id="remember"><label for="remember">Remember Me</label></div></div><div class="col-5"><button class="btn btn-primary btn-block btn-flat text-bold" id="submitLogin"><i class="fas fa-sign-in-alt"></i>&ensp;Sign In</button></div></div><p class="mb-1"><a href="/lost_password">I forgot my password</a></p><p class="mb-0"><a href="/register" class="text-center">Register a new membership</a></p></div></div></div>`;
    $('#view-login-page').html(loginForm);
}

const submitLogin = (email, password) => {
    axios.post(`/api/signin`, { email, password }, { headers: { 'Content-Type': 'application/json' } }).then(response => responseLogin(response.data)).catch(error => toastWarning(error));
}

const responseLogin = async (data) => {
    await sleep(1000);
    (data.status == 'success') ? ($('#login-head-message').html(`<label class="text-success">Welcome ${data.response_data[0].name}</label>`), localStorage.clear(), localStorage.setItem('_jwtApiToken', data.response_data[0].token), localStorage.setItem('_credentials', JSON.stringify({ 'name': data.response_data[0].name, 'email': data.response_data[0].email })), redirectTo('/home')) : $('#login-head-message').html(`<label class="text-info">${data.message}</label>`);
}

$(createLoginForm());
$(async () => {
    await sleep(2000), checkAuth()
});
