$(document).on('keyup', '#name', function (e) {
    if (event.keyCode === 13) {
        e.preventDefault();
        $('#email').focus()
    }
});
$(document).on('keyup', '#email', function (e) {
    if (event.keyCode === 13) {
        e.preventDefault();
        $('#password').focus()
    }
});
$(document).on('keyup', '#password', function (e) {
    if (event.keyCode === 13) {
        e.preventDefault();
        $('#c_password').focus()
    }
});
$(document).on('keyup', '#c_password', function (e) {
    if (event.keyCode === 13) {
        e.preventDefault();
        $('#submitRegister').click()
    }
});
$(document).on('click', '#submitRegister', function () {
    let name = $('#name').val();
    let email = $('#email').val();
    let password = $('#password').val();
    let c_password = $('#c_password').val();
    $('#name-form').removeClass('mb-1'),
        $('#name-form').addClass('mb-3'),
        $('#name-warn').hide();
    $('#email-form').removeClass('mb-1'),
        $('#email-form').addClass('mb-3'),
        $('#email-warn').hide();
    $('#password-form').removeClass('mb-1'),
        $('#password-form').addClass('mb-3'),
        $('#password-warn').hide();
    $('#c_password-form').removeClass('mb-1'),
        $('#c_password-form').addClass('mb-3'),
        $('#c_password-warn').hide();
    if (name && email && password && c_password) {
        if (password == c_password) {
            let ma = forge.md.sha512.sha384.create();
            let mb = forge.md.sha512.sha384.create();
            ma.update(password);
            mb.update(c_password);
            let new_pass_enc = ma.digest().toHex();
            let confirm_pass_enc = mb.digest().toHex();
            submitRegister(name, email, new_pass_enc, confirm_pass_enc);
        } else {
            $('#c_password-form').removeClass('mb-3'), $('#c_password-form').addClass('mb-1'), $('#c_password-warn').show()
        }
    }
    if (!name) {
        $('#name-form').removeClass('mb-3'), $('#name-form').addClass('mb-1'), $('#name-warn').show()
    }
    if (!email) {
        $('#email-form').removeClass('mb-3'), $('#email-form').addClass('mb-1'), $('#email-warn').show()
    }
    if (!password) {
        $('#password-form').removeClass('mb-3'), $('#password-form').addClass('mb-1'), $('#password-warn').show()
    }
    if (!c_password) {
        $('#c_password-form').removeClass('mb-3'), $('#c_password-form').addClass('mb-1'), $('#c_password-warn').show()
    }
});

const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));
const redirectTo = async (url) => {
    await sleep(3000);
    $(location).attr('href', url);
}

const createRegisterForm = () => {
    let registerForm = `<div class="login-box"><div class="login-logo"><a href="/" class="text-white" style="font-size: 40px; opacity: .8;"><b>Laravel</b> Startup</a></div><div class="card shadow-lg p-3 mb-5 bg-white rounded"><div class="card-body login-card-body"><p class="login-box-msg" id="register-head-message">Create your account and join with us</p><div class="form-group"><div class="input-group mb-3" id="name-form"><input type="text" id="name" class="form-control" placeholder="John Doe"><div class="input-group-append"><div class="input-group-text"><span class="fas fa-user"></span></div></div></div><label class="text-info" id="name-warn" style="display: none;">Name incorrect</label></div><div class="form-group"><div class="input-group mb-3" id="email-form"><input type="email" id="email" class="form-control" placeholder="Email@mail.com"><div class="input-group-append"><div class="input-group-text"><span class="fas fa-envelope"></span></div></div></div><label class="text-info" id="email-warn" style="display: none;">Email incorrect</label></div><div class="form-group"><div class="input-group mb-3" id="password-form"><input type="password" class="form-control" id="password" placeholder="Password"><div class="input-group-append"><div class="input-group-text"><span class="fas fa-lock"></span></div></div></div><label class="text-info" id="password-warn" style="display: none;">Password incorrect</label></div><div class="form-group"><div class="input-group mb-3" id="c_password-form"><input type="password" class="form-control" id="c_password" placeholder="Password Confirmation"><div class="input-group-append"><div class="input-group-text"><span class="fas fa-lock"></span></div></div></div><label class="text-info" id="c_password-warn" style="display: none;">Password Confirmation incorrect</label></div><div class="row"><div class="col-7"></div><div class="col-5"><button class="btn btn-primary btn-block btn-flat text-bold" id="submitRegister"><i class="fas fa-sign-in-alt"></i>&ensp;Register</button></div></div><p class="mb-1"><a href="/lost_password">I forgot my password</a></p><p class="mb-0"><a href="/signin" class="text-center">I already have an account</a></p></div></div></div>`;
    $('#view-register-page').html(registerForm);
}

const submitRegister = (name, email, password, c_password) => {
    axios.post(`/api/register`, { name, email, password, c_password }, { headers: { 'Content-Type': 'application/json' } }).then(response => responseRegister(response.data)).catch(error => toastWarning(error));
}

const responseRegister = async (data) => {
    await sleep(1000);
    (data.status == 'success') ? ($('#register-head-message').html(`<label class="text-success">Your account has been successfully registered, please login</label>`), redirectTo('/signin')) : $('#register-head-message').html(`<label class="text-info">${data.message}</label>`);
}

$(createRegisterForm());
